.data
msg_div_zero: .asciiz "Illegal Division By Zero"
msg_null_ptr: .asciiz "Invalid Pointer Dereference"
msg_bounds: .asciiz "Access Violation"
dog_10: .word 0
dogi_11: .word 0
p_10: .word 0

.text
.globl main

main:
    j __user_main    # Jump to main function
__user_main:
    # Function prologue
    addi $sp, $sp, -8    # allocate stack frame
    sw $ra, 4($sp)    # save return address
    sw $fp, 0($sp)    # save frame pointer
    addi $fp, $sp, 8    # set new frame pointer

    # Allocate dog_10
    # Allocate dog_10

    # Temp_0 := NEW_OBJECT("SmallDog", size=20)
    # Allocate object: SmallDog
    li $a0, 20
    li $v0, 9    # malloc
    syscall
    move $t0, $v0
    sw $zero, 0($v0)
    sw $zero, 4($v0)
    sw $zero, 8($v0)
    sw $zero, 12($v0)
    sw $zero, 16($v0)

    # dog_10 := Temp_0
    sw $t0, dog_10

    # Allocate dogi_11
    # Allocate dogi_11

    # Temp_1 := NEW_OBJECT("BigDog", size=20)
    # Allocate object: BigDog
    li $a0, 20
    li $v0, 9    # malloc
    syscall
    move $t0, $v0
    sw $zero, 0($v0)
    sw $zero, 4($v0)
    sw $zero, 8($v0)
    sw $zero, 12($v0)
    sw $zero, 16($v0)

    # dogi_11 := Temp_1
    # Save dogi_11 before store (recursive call ahead)
    addi $sp, $sp, -4    # allocate space
    lw $t8, dogi_11    # load current value
    sw $t8, 0($sp)    # save on stack
    sw $t0, dogi_11

    # Temp_2 := go()
    # Save caller-saved registers
    addi $sp, $sp, -40    # allocate space for $t0-$t9
    sw $t0, 0($sp)
    sw $t1, 4($sp)
    sw $t2, 8($sp)
    sw $t3, 12($sp)
    sw $t4, 16($sp)
    sw $t5, 20($sp)
    sw $t6, 24($sp)
    sw $t7, 28($sp)
    sw $t8, 32($sp)
    sw $t9, 36($sp)
    jal go
    move $t0, $v0    # save return value
    # Restore caller-saved registers
    lw $t1, 4($sp)
    lw $t2, 8($sp)
    lw $t3, 12($sp)
    lw $t4, 16($sp)
    lw $t5, 20($sp)
    lw $t6, 24($sp)
    lw $t7, 28($sp)
    lw $t8, 32($sp)
    lw $t9, 36($sp)
    addi $sp, $sp, 40    # deallocate register save area
    # Restore dogi_11 after call (from pre-store save)
    lw $t8, 0($sp)    # load saved value
    sw $t8, dogi_11    # restore global
    addi $sp, $sp, 4    # deallocate global save space

    # Temp_3 := come()
    # Save caller-saved registers
    addi $sp, $sp, -40    # allocate space for $t0-$t9
    sw $t0, 0($sp)
    sw $t1, 4($sp)
    sw $t2, 8($sp)
    sw $t3, 12($sp)
    sw $t4, 16($sp)
    sw $t5, 20($sp)
    sw $t6, 24($sp)
    sw $t7, 28($sp)
    sw $t8, 32($sp)
    sw $t9, 36($sp)
    jal come
    move $t0, $v0    # save return value
    # Restore caller-saved registers
    lw $t1, 4($sp)
    lw $t2, 8($sp)
    lw $t3, 12($sp)
    lw $t4, 16($sp)
    lw $t5, 20($sp)
    lw $t6, 24($sp)
    lw $t7, 28($sp)
    lw $t8, 32($sp)
    lw $t9, 36($sp)
    addi $sp, $sp, 40    # deallocate register save area

    # Temp_4 := go()
    # Save caller-saved registers
    addi $sp, $sp, -40    # allocate space for $t0-$t9
    sw $t0, 0($sp)
    sw $t1, 4($sp)
    sw $t2, 8($sp)
    sw $t3, 12($sp)
    sw $t4, 16($sp)
    sw $t5, 20($sp)
    sw $t6, 24($sp)
    sw $t7, 28($sp)
    sw $t8, 32($sp)
    sw $t9, 36($sp)
    jal go
    move $t0, $v0    # save return value
    # Restore caller-saved registers
    lw $t1, 4($sp)
    lw $t2, 8($sp)
    lw $t3, 12($sp)
    lw $t4, 16($sp)
    lw $t5, 20($sp)
    lw $t6, 24($sp)
    lw $t7, 28($sp)
    lw $t8, 32($sp)
    lw $t9, 36($sp)
    addi $sp, $sp, 40    # deallocate register save area

    # p_10 := Temp_4
    sw $t0, p_10

    # Temp_5 := PrintInt()
    # Save caller-saved registers
    addi $sp, $sp, -40    # allocate space for $t0-$t9
    sw $t0, 0($sp)
    sw $t1, 4($sp)
    sw $t2, 8($sp)
    sw $t3, 12($sp)
    sw $t4, 16($sp)
    sw $t5, 20($sp)
    sw $t6, 24($sp)
    sw $t7, 28($sp)
    sw $t8, 32($sp)
    sw $t9, 36($sp)
    jal PrintInt
    move $t0, $v0    # save return value
    # Restore caller-saved registers
    lw $t1, 4($sp)
    lw $t2, 8($sp)
    lw $t3, 12($sp)
    lw $t4, 16($sp)
    lw $t5, 20($sp)
    lw $t6, 24($sp)
    lw $t7, 28($sp)
    lw $t8, 32($sp)
    lw $t9, 36($sp)
    addi $sp, $sp, 40    # deallocate register save area

    # Exit program
    li $v0, 10
    syscall

error_div_by_zero:
    la $a0, msg_div_zero
    li $v0, 4
    syscall
    li $v0, 10
    syscall

error_null_pointer:
    la $a0, msg_null_ptr
    li $v0, 4
    syscall
    li $v0, 10
    syscall

error_bounds:
    la $a0, msg_bounds
    li $v0, 4
    syscall
    li $v0, 10
    syscall

PrintInt:
    # Print integer (expects value in p_10 variable)
    lw $a0, p_10    # load value to print
    li $v0, 1    # syscall: print_int
    syscall
    li $a0, 32    # print space
    li $v0, 11    # syscall: print_char
    syscall
    jr $ra    # return

PrintString:
    # Print string (expects value in p_10 variable)
    lw $a0, p_10    # load string address to print
    li $v0, 4    # syscall: print_string
    syscall
    jr $ra    # return

# Program exit
    li $v0, 10
    syscall
